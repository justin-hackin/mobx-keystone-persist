"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t=require("mobx-keystone"),n=(e=require("lodash.debounce"))&&"object"==typeof e&&"default"in e?e.default:e;function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}var o={clear:function(){return i((function(){return window.localStorage.clear()}))},getItem:function(e){return i((function(){return window.localStorage.getItem(e)}))},removeItem:function(e){return i((function(){return window.localStorage.removeItem(e)}))},setItem:function(e,t){return i((function(){return window.localStorage.setItem(e,t)}))}};function i(e){try{for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return Promise.resolve(e.apply(void 0,n))}catch(e){return Promise.reject(e)}}var s=function(e,i,s){void 0===s&&(s={});try{var u=s.storage,a=s.jsonify,c=void 0===a||a,f=s.whitelist,l=s.blacklist,h=s.version,v=void 0===h?-1:h,d=s.migrate,p=s.throttle;if("undefined"==typeof window||void 0===window.localStorage||u&&u!==window.localStorage||(u=o),!u)return Promise.reject("localStorage (the default storage engine) is not supported in this environment. Please configure a different storage engine via the `storage:` option.");var y=new Set(f||[]),m=new Set(l||[]),g=function(n){var o=r({},n);Object.keys(o).forEach((function(e){e!==t.modelTypeKey&&e!==t.modelIdKey&&(f&&!y.has(e)&&delete o[e],l&&m.has(e)&&delete o[e])}));var i={version:s.version||-1,snapshot:o},a=c?JSON.stringify(i):i;u.setItem(e,a)};return t.onSnapshot(i,"number"==typeof p?n(g,p):g),Promise.resolve(u.getItem(e)).then((function(e){function n(){for(var e=t.getSnapshot(i),n=0,o=Object.keys(s.snapshot);n<o.length;n++){var u=o[n];u in e||(console.warn("mobx-keystone-persist: persisted store contained non-existent key: "+u),delete s.snapshot[u])}t.applySnapshot(i,r({},e,s.snapshot,{$modelId:i.$modelId}))}var o="string"!=typeof e?e:JSON.parse(e);if(o){var s;s=function(e){return e&&void 0!==e.$modelId}(o)?{version:-1,snapshot:o}:o;var u=function(){if(d)return Promise.resolve(d(s,v)).then((function(e){s=e}))}();return u&&u.then?u.then(n):n()}}))}catch(e){return Promise.reject(e)}};const u=function(){function e(){}return e.prototype.then=function(t,n){const r=new e,o=this.s;if(o){const e=1&o?t:n;if(e){try{a(r,1,e(this.v))}catch(e){a(r,2,e)}return r}return this}return this.o=function(e){try{const o=e.v;1&e.s?a(r,1,t?t(o):o):n?a(r,1,n(o)):a(r,2,o)}catch(e){a(r,2,e)}},r},e}();function a(e,t,n){if(!e.s){if(n instanceof u){if(!n.s)return void(n.o=a.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(a.bind(null,e,t),a.bind(null,e,2));e.s=t,e.v=n;const r=e.o;r&&r(e)}}function c(e){return e instanceof u&&1&e.s}const f="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator"))),exports.AsyncLocalStorage=o,exports.DEFAULT_VERSION=-1,exports.createMigrate=function(e,t){return function(t,n){try{var r=void 0!==t.version?t.version:-1;if(r===n)return Promise.resolve(t);if(r>n)throw new Error("downgrading version is not supported");var o=function(e,t,n){if("function"==typeof e[f]){var r,o,i,s=e[f]();if(function e(n){try{for(;!(r=s.next()).done;)if((n=t(r.value))&&n.then){if(!c(n))return void n.then(e,i||(i=a.bind(null,o=new u,2)));n=n.v}o?a(o,1,n):o=n}catch(e){a(o||(o=new u),2,e)}}(),s.return){var l=function(e){try{r.done||s.return()}catch(e){}return e};if(o&&o.then)return o.then(l,(function(e){throw l(e)}));l()}return o}if(!("length"in e))throw new TypeError("Object is not iterable");for(var h=[],v=0;v<e.length;v++)h.push(e[v]);return function(e,t,n){var r,o,i=-1;return function n(s){try{for(;++i<e.length;)if((s=t(i))&&s.then){if(!c(s))return void s.then(n,o||(o=a.bind(null,r=new u,2)));s=s.v}r?a(r,1,s):r=s}catch(e){a(r||(r=new u),2,e)}}(),r}(h,(function(e){return t(h[e])}))}(Object.keys(e).map((function(e){return parseInt(e)})).filter((function(e){return n>=e&&e>r})).sort((function(e,t){return e-t})),(function(n){function r(e){t={version:n,snapshot:e}}var o=e[n](t.snapshot);return"then"in o?Promise.resolve(o).then(r):r(o)}));return Promise.resolve(o&&o.then?o.then((function(){return t})):t)}catch(e){return Promise.reject(e)}}},exports.default=s,exports.persist=s;
//# sourceMappingURL=mobx-keystone-persist.cjs.production.min.js.map
